{% extends 'base.html' %}
{% load widget_tweaks %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-5 col-md-7 col-sm-9">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white text-center">
                    <h3 class="mb-0">
                        <i class="fa-solid fa-user-pen me-2"></i>
                        Chỉnh sửa thông tin cá nhân
                    </h3>
                </div>

                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}

                        <!-- AVATAR -->
                        <div class="text-center mb-4">
                            <label class="form-label fw-bold d-block mb-2">
                                Ảnh đại diện
                            </label>

                            <div style="position: relative; display: inline-block; width:150px; height:150px;">
                                {% if profile.avatar %}
                                    <img
                                        id="avatar-preview"
                                        src="{{ profile.avatar.url }}"
                                        alt="Avatar"
                                        class="rounded-circle shadow"
                                        style="width:150px; height:150px; object-fit:cover; border:3px solid #007bff;"
                                    >
                                {% else %}
                                    <div
                                        id="avatar-preview"
                                        class="rounded-circle shadow d-flex align-items-center justify-content-center text-secondary fw-bold"
                                        style="
                                            width:150px;
                                            height:150px;
                                            border:3px dashed #007bff;
                                            background:#f8f9fa;
                                            font-size:14px;
                                        ">
                                        Ảnh đại diện
                                    </div>
                                {% endif %}

                                <input
                                    type="file"
                                    id="id_avatar"
                                    name="avatar"
                                    class="d-none"
                                    accept="image/*"
                                >

                                <span
                                    onclick="document.getElementById('id_avatar').click();"
                                    title="Chọn ảnh mới"
                                    style="
                                        position:absolute;
                                        bottom:5px;
                                        right:5px;
                                        background:#007bff;
                                        color:white;
                                        border-radius:50%;
                                        width:40px;
                                        height:40px;
                                        display:flex;
                                        align-items:center;
                                        justify-content:center;
                                        cursor:pointer;
                                        box-shadow:0 2px 5px rgba(0,0,0,0.3);
                                    "
                                >
                                    <i class="fa-solid fa-camera"></i>
                                </span>
                            </div>

                            <div class="form-text mt-2">
                                JPG, PNG, GIF – tối đa 5MB
                            </div>
                        </div>

                        <!-- USERNAME -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Username</label>
                            <input type="text" class="form-control" value="{{ request.user.username }}" readonly>
                        </div>

                        <!-- EMAIL -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Email</label>
                            <input type="email" class="form-control" value="{{ request.user.email }}" readonly>
                        </div>

                        <!-- PHONE -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Số điện thoại</label>
                            {{ form.phone|add_class:"form-control" }}
                        </div>

                        <!-- ADDRESS (ĐÃ THU NHỎ) -->
                        <div class="mb-3">
    <label class="form-label fw-bold">Giới thiệu</label>
    {{ form.bio|add_class:"form-control"|attr:"rows:3"|attr:"style:height:90px;resize:vertical;" }}
</div>


                        <!-- BIO (ĐÃ THU NHỎ) -->
                      <div class="mb-3">
    <label class="form-label fw-bold">Địa chỉ</label>
    {{ form.address|add_class:"form-control"|attr:"rows:2"|attr:"style:height:70px;resize:vertical;" }}
</div>


                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success flex-grow-1 fw-bold">
                                <i class="fa-solid fa-floppy-disk me-2"></i>
                                Lưu thay đổi
                            </button>
                            <a href="{% url 'profile' %}" class="btn btn-outline-secondary">
                                Hủy
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- STYLE -->
<style>
/* Hover avatar */
#avatar-preview {
    transition: transform 0.3s, box-shadow 0.3s;
}
#avatar-preview:hover {
    transform: scale(1.05);
    box-shadow: 0 0 0 4px rgba(13,110,253,.25);
}

/* Thu nhỏ textarea */
.address-textarea {
    min-height: 80px;
    resize: vertical;
}

.bio-textarea {
    min-height: 100px;
    resize: vertical;
}
</style>

<!-- SCRIPT PREVIEW -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const avatarInput = document.getElementById('id_avatar');

    avatarInput.addEventListener('change', function () {
        const file = this.files[0];
        if (!file) return;

        const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/jpg'];
        if (!validTypes.includes(file.type)) {
            alert('Chỉ chấp nhận ảnh JPG, PNG, GIF');
            this.value = '';
            return;
        }

        if (file.size > 5 * 1024 * 1024) {
            alert('Ảnh tối đa 5MB');
            this.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
            const preview = document.getElementById('avatar-preview');

            if (preview.tagName === 'IMG') {
                preview.src = e.target.result;
            } else {
                const img = document.createElement('img');
                img.id = 'avatar-preview';
                img.src = e.target.result;
                img.className = 'rounded-circle shadow';
                img.style.cssText =
                    'width:150px;height:150px;object-fit:cover;border:3px solid #007bff;';
                preview.replaceWith(img);
            }
        };
        reader.readAsDataURL(file);
    });
});
</script>

{% endblock %}
