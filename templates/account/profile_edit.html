{% extends 'base.html' %}

{% block content %}
{% load widget_tweaks %}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-5 col-md-7 col-sm-9">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white text-center">
                    <h3 class="mb-0"><i class="fa-solid fa-user-pen me-2"></i>Chỉnh sửa thông tin cá nhân</h3>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="profile-form">
                        {% csrf_token %}

                        <!-- Avatar -->
                        <div class="text-center mb-4">
                            <label class="form-label fw-bold d-block mb-2">Ảnh đại diện</label>
                            <div style="position: relative; display: inline-block;">
                                {% if profile.avatar %}
                                    <img id="avatar-preview" src="{{ profile.avatar.url }}" alt="Avatar" 
                                         class="rounded-circle shadow" 
                                         style="width:150px; height:150px; object-fit:cover; border:3px solid #007bff;">
                                {% else %}
                                    <div id="avatar-preview" class="rounded-circle bg-secondary d-flex justify-content-center align-items-center shadow"
                                         style="width:150px; height:150px; color:white; font-size:50px; cursor:pointer;">
                                        {{ profile.user.username|first|upper }}
                                    </div>
                                {% endif %}
                                
                                <input type="file" id="id_avatar" name="avatar" class="d-none" accept="image/*">
                                
                                <span style="position:absolute; bottom:5px; right:5px; background:#007bff; color:white; border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"
                                      onclick="document.getElementById('id_avatar').click();" 
                                      title="Chọn ảnh mới">
                                    <i class="fa-solid fa-camera"></i>
                                </span>
                            </div>
                            <div class="form-text mt-2">
                                <i class="fa-solid fa-circle-info me-1"></i>Ảnh JPG, PNG, GIF (tối đa 5MB)
                            </div>
                        </div>

                        <!-- Username & Email -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Username</label>
                            <input type="text" class="form-control" value="{{ profile.user.username }}" readonly>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Email</label>
                            <input type="email" class="form-control" value="{{ profile.user.email }}" readonly>
                        </div>

                        <!-- Các field khác -->
                        <div class="mb-3">
                            <label for="id_phone" class="form-label fw-bold">Số điện thoại</label>
                            {{ form.phone|add_class:"form-control" }}
                        </div>

                        <div class="mb-3">
                            <label for="id_address" class="form-label fw-bold">Địa chỉ</label>
                            {{ form.address|add_class:"form-control" }}
                        </div>

                        <div class="mb-3">
                            <label for="id_bio" class="form-label fw-bold">Giới thiệu bản thân</label>
                            {{ form.bio|add_class:"form-control" }}
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success flex-grow-1 fw-bold">
                                <i class="fa-solid fa-floppy-disk me-2"></i>Lưu thay đổi
                            </button>
                            <a href="{% url 'profile' %}" class="btn btn-outline-secondary">
                                <i class="fa-solid fa-times me-2"></i>Hủy
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
#avatar-preview {
    transition: transform 0.3s, border-color 0.3s;
}

#avatar-preview:hover {
    transform: scale(1.05);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const avatarInput = document.getElementById('id_avatar');
    const avatarPreview = document.getElementById('avatar-preview');
    
    // Lưu URL ảnh gốc
    const originalImageSrc = avatarPreview.tagName === 'IMG' ? avatarPreview.src : null;
    const originalContent = avatarPreview.innerHTML;

    avatarInput.addEventListener('change', function() {
        const file = this.files[0];
        
        if (file) {
            // Kiểm tra định dạng file
            const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/jpg'];
            if (!validTypes.includes(file.type)) {
                alert('Vui lòng chọn file ảnh (JPG, PNG, GIF)');
                avatarInput.value = '';
                return;
            }
            
            // Kiểm tra kích thước file
            if (file.size > 5 * 1024 * 1024) {
                alert('File ảnh quá lớn. Chọn file nhỏ hơn 5MB');
                avatarInput.value = '';
                return;
            }

            // Hiển thị preview ảnh mới
            const reader = new FileReader();
            reader.onload = function(e) {
                if(avatarPreview.tagName === 'IMG') {
                    // Nếu đã có ảnh, chỉ cần thay đổi src
                    avatarPreview.src = e.target.result;
                } else {
                    // Nếu chưa có ảnh, tạo thẻ img mới
                    const newImg = document.createElement('img');
                    newImg.id = 'avatar-preview';
                    newImg.src = e.target.result;
                    newImg.alt = 'Avatar';
                    newImg.className = 'rounded-circle shadow';
                    newImg.style.cssText = 'width:150px; height:150px; object-fit:cover; border:3px solid #007bff;';
                    avatarPreview.parentNode.replaceChild(newImg, avatarPreview);
                }
            }
            reader.readAsDataURL(file);
        } else {
            // Nếu người dùng hủy chọn file, khôi phục ảnh cũ
            if (originalImageSrc && avatarPreview.tagName === 'IMG') {
                avatarPreview.src = originalImageSrc;
            }
        }
    });
});
</script>

{% endblock %}